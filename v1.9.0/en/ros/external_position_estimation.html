
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>External Position Estimation (Vision/Motion based) Â· PX4 v1.9.0 Developer Guide</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-richquotes/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-language-picker/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-versions-select/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-dronecode/theme_styles.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../robotics/dronekit.html" />
    
    
    <link rel="prev" href="raspberrypi_installation.html" />
    

    </head>
    <body>
        
    
    <!-- ##HW Add dronecode menu -->
    <div id="common_dronecode_menu">

      <div class="common_menu_logo large_version">
        <a href="https://www.dronecode.org/">
          <img src="../../gitbook/gitbook-plugin-theme-dronecode/images/dronecode_top_bar_logo_full.png" alt="Dronecode logo (large)" />
        </a>
      </div>
      <div class="common_menu_logo small_version">
        <a href="https://www.dronecode.org/">
          <img src="../../gitbook/gitbook-plugin-theme-dronecode/images/dronecode_top_bar_logo_small.png" alt="Dronecode logo (small)" />
        </a>
      </div>
      
      <div class="common_menu_options">
        
            <div class="common_dronecode_menu_item"><a href="http://px4.io/">PX4</a></div>
            <div class="common_dronecode_menu_item large_version"><a href="http://qgroundcontrol.com/">QGroundControl</a></div>
            <div class="common_dronecode_menu_item small_version"><a href="http://qgroundcontrol.com/">QGC</a></div>
            <div class="common_dronecode_menu_item"><a href="https://www.dronecode.org/sdk/">SDK</a></div>
            <div class="common_dronecode_menu_item"><a href="https://mavlink.io/en/">MAVLink</a></div>
            <div class="common_dronecode_menu_item large_version"><a href="https://www.dronecode.org/documentation/">Documentation</a></div>
            <div class="common_dronecode_menu_item small_version"><a href="https://www.dronecode.org/documentation/">Docs</a></div>
            <div class="common_dronecode_menu_item large_version"><a href="http://discuss.px4.io/">Support</a></div>
            <div class="common_dronecode_menu_item small_version"><a href="http://discuss.px4.io/">Help</a></div>
        
      </div>
    </div>
    
<!-- ##HW END Add dronecode menu -->
    
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../setup/getting_started.html">
            
                <a href="../setup/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../setup/config_initial.html">
            
                <a href="../setup/config_initial.html">
            
                    
                    Initial Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../setup/dev_env.html">
            
                <a href="../setup/dev_env.html">
            
                    
                    Toolchain Installation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../setup/dev_env_mac.html">
            
                <a href="../setup/dev_env_mac.html">
            
                    
                    Mac OS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../setup/dev_env_linux.html">
            
                <a href="../setup/dev_env_linux.html">
            
                    
                    Linux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.2.1" data-path="../setup/dev_env_linux_ubuntu.html">
            
                <a href="../setup/dev_env_linux_ubuntu.html">
            
                    
                    Ubuntu/Debian Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2.2" data-path="../setup/dev_env_linux_centos.html">
            
                <a href="../setup/dev_env_linux_centos.html">
            
                    
                    CentOS Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2.3" data-path="../setup/dev_env_linux_arch.html">
            
                <a href="../setup/dev_env_linux_arch.html">
            
                    
                    Arch Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2.4" data-path="../setup/dev_env_advanced_linux.html">
            
                <a href="../setup/dev_env_advanced_linux.html">
            
                    
                    Advanced Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="../setup/dev_env_windows.html">
            
                <a href="../setup/dev_env_windows.html">
            
                    
                    Windows
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.3.1" data-path="../setup/dev_env_windows_cygwin.html">
            
                <a href="../setup/dev_env_windows_cygwin.html">
            
                    
                    Cygwin Toolchain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3.2" data-path="../setup/dev_env_windows_vm.html">
            
                <a href="../setup/dev_env_windows_vm.html">
            
                    
                    Virtual Machine Toolchain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3.3" data-path="../setup/dev_env_windows_bash_on_win.html">
            
                <a href="../setup/dev_env_windows_bash_on_win.html">
            
                    
                    Bash on Windows Toolchain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3.4" data-path="../setup/dev_env_windows_msys.html">
            
                <a href="../setup/dev_env_windows_msys.html">
            
                    
                    Msys Toolchain
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="../setup/fast-rtps-installation.html">
            
                <a href="../setup/fast-rtps-installation.html">
            
                    
                    Fast RTPS installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="../setup/generic_dev_tools.html">
            
                <a href="../setup/generic_dev_tools.html">
            
                    
                    Additional Tools
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../setup/building_px4.html">
            
                <a href="../setup/building_px4.html">
            
                    
                    Building the Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../apps/hello_sky.html">
            
                <a href="../apps/hello_sky.html">
            
                    
                    Writing your First Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../apps/module_template.html">
            
                <a href="../apps/module_template.html">
            
                    
                    Application/Module Template
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../concept/">
            
                <a href="../concept/">
            
                    
                    Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../concept/architecture.html">
            
                <a href="../concept/architecture.html">
            
                    
                    PX4 Architectural Overview
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../flight_stack/controller_diagrams.html">
            
                <a href="../flight_stack/controller_diagrams.html">
            
                    
                    Controller Diagrams
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../concept/dronecode_architecture.html">
            
                <a href="../concept/dronecode_architecture.html">
            
                    
                    Dronecode Platform Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../concept/flight_modes.html">
            
                <a href="../concept/flight_modes.html">
            
                    
                    Flight Modes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../concept/mixing.html">
            
                <a href="../concept/mixing.html">
            
                    
                    Mixing and Actuators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../concept/pwm_limit.html">
            
                <a href="../concept/pwm_limit.html">
            
                    
                    PWM limit state machine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../concept/system_startup.html">
            
                <a href="../concept/system_startup.html">
            
                    
                    System Startup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../simulation/">
            
                <a href="../simulation/">
            
                    
                    Simulation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../simulation/jmavsim.html">
            
                <a href="../simulation/jmavsim.html">
            
                    
                    jMAVSim Simulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../simulation/gazebo.html">
            
                <a href="../simulation/gazebo.html">
            
                    
                    Gazebo Simulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../simulation/airsim.html">
            
                <a href="../simulation/airsim.html">
            
                    
                    AirSim Simulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../simulation/multi_vehicle_jmavsim.html">
            
                <a href="../simulation/multi_vehicle_jmavsim.html">
            
                    
                    Multi-Vehicle Sim with JMAVSim
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../simulation/multi-vehicle-simulation.html">
            
                <a href="../simulation/multi-vehicle-simulation.html">
            
                    
                    Multi-Vehicle Sim with Gazebo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../simulation/failsafes.html">
            
                <a href="../simulation/failsafes.html">
            
                    
                    Simulate Failsafes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../simulation/hitl.html">
            
                <a href="../simulation/hitl.html">
            
                    
                    HITL Simulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../simulation/simulation-in-hardware.html">
            
                <a href="../simulation/simulation-in-hardware.html">
            
                    
                    Simulation-In-Hardware
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../hardware/">
            
                <a href="../hardware/">
            
                    
                    Hardware
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../debug/reference-design.html">
            
                <a href="../debug/reference-design.html">
            
                    
                    Flight Controller Reference Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../hardware/porting_guide.html">
            
                <a href="../hardware/porting_guide.html">
            
                    
                    Flight Controller Porting Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../airframes/">
            
                <a href="../airframes/">
            
                    
                    Airframes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.1" data-path="../airframes/airframe_reference.html">
            
                <a href="../airframes/airframe_reference.html">
            
                    
                    Airframes Reference
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2" data-path="../airframes/adding_a_new_frame.html">
            
                <a href="../airframes/adding_a_new_frame.html">
            
                    
                    Adding a New Airframe
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../middleware/drivers.html">
            
                <a href="../middleware/drivers.html">
            
                    
                    Device Drivers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../data_links/telemetry.html">
            
                <a href="../data_links/telemetry.html">
            
                    
                    Telemetry Radio
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.5.1" data-path="../data_links/sik_radio.html">
            
                <a href="../data_links/sik_radio.html">
            
                    
                    SiK Radio
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../sensor_bus/">
            
                <a href="../sensor_bus/">
            
                    
                    Sensor and Actuator I/O
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.6.1" data-path="../sensor_bus/i2c.html">
            
                <a href="../sensor_bus/i2c.html">
            
                    
                    I2C Bus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.2" data-path="../uavcan/">
            
                <a href="../uavcan/">
            
                    
                    UAVCAN Bus
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.6.2.1" data-path="../uavcan/bootloader_installation.html">
            
                <a href="../uavcan/bootloader_installation.html">
            
                    
                    UAVCAN Bootloader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.2.2" data-path="../uavcan/node_firmware.html">
            
                <a href="../uavcan/node_firmware.html">
            
                    
                    UAVCAN Firmware Upgrades
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.2.3" data-path="../uavcan/node_enumeration.html">
            
                <a href="../uavcan/node_enumeration.html">
            
                    
                    UAVCAN Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.2.4" data-path="../uavcan/notes.html">
            
                <a href="../uavcan/notes.html">
            
                    
                    UAVCAN Various Notes
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.6.3" data-path="../uart/">
            
                <a href="../uart/">
            
                    
                    UART/Serial Ports
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.6.3.1" data-path="../uart/user_configurable_serial_driver.html">
            
                <a href="../uart/user_configurable_serial_driver.html">
            
                    
                    Port-Configurable Serial Drivers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../advanced/rtk_gps.html">
            
                <a href="../advanced/rtk_gps.html">
            
                    
                    RTK GPS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="../advanced/gimbal_control.html">
            
                <a href="../advanced/gimbal_control.html">
            
                    
                    Gimbal (Mount) Control Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="../companion_computer/pixhawk_companion.html">
            
                <a href="../companion_computer/pixhawk_companion.html">
            
                    
                    Companion Computers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../middleware/">
            
                <a href="../middleware/">
            
                    
                    Middleware
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../middleware/uorb.html">
            
                <a href="../middleware/uorb.html">
            
                    
                    uORB Messaging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../middleware/uorb_graph.html">
            
                <a href="../middleware/uorb_graph.html">
            
                    
                    uORB Graph
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../middleware/mavlink.html">
            
                <a href="../middleware/mavlink.html">
            
                    
                    MAVLink Messaging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../middleware/micrortps.html">
            
                <a href="../middleware/micrortps.html">
            
                    
                    RTPS/ROS2 Interface
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.4.1" data-path="../middleware/micrortps_throughput_test.html">
            
                <a href="../middleware/micrortps_throughput_test.html">
            
                    
                    Throughput Test
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.2" data-path="../middleware/micrortps_manual_code_generation.html">
            
                <a href="../middleware/micrortps_manual_code_generation.html">
            
                    
                    Manually Generate Client/Agent
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../middleware/modules_main.html">
            
                <a href="../middleware/modules_main.html">
            
                    
                    Modules & Commands
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../middleware/modules_command.html">
            
                <a href="../middleware/modules_command.html">
            
                    
                    Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../middleware/modules_communication.html">
            
                <a href="../middleware/modules_communication.html">
            
                    
                    Communication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../middleware/modules_controller.html">
            
                <a href="../middleware/modules_controller.html">
            
                    
                    Controllers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../middleware/modules_driver.html">
            
                <a href="../middleware/modules_driver.html">
            
                    
                    Drivers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="../middleware/modules_driver_distance_sensor.html">
            
                <a href="../middleware/modules_driver_distance_sensor.html">
            
                    
                    Distance Sensor
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../middleware/modules_estimator.html">
            
                <a href="../middleware/modules_estimator.html">
            
                    
                    Estimators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../middleware/modules_simulation.html">
            
                <a href="../middleware/modules_simulation.html">
            
                    
                    Simulations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../middleware/modules_system.html">
            
                <a href="../middleware/modules_system.html">
            
                    
                    System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="../middleware/modules_template.html">
            
                <a href="../middleware/modules_template.html">
            
                    
                    Template
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../robotics/">
            
                <a href="../robotics/">
            
                    
                    Robotics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="offboard_control.html">
            
                <a href="offboard_control.html">
            
                    
                    Offboard Control from Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="./">
            
                <a href="./">
            
                    
                    ROS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="mavros_installation.html">
            
                <a href="mavros_installation.html">
            
                    
                    MAVROS (MAVLink on ROS)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="mavros_offboard.html">
            
                <a href="mavros_offboard.html">
            
                    
                    MAVROS Offboard Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.3" data-path="../simulation/ros_interface.html">
            
                <a href="../simulation/ros_interface.html">
            
                    
                    ROS with Gazebo Simulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.4" data-path="../simulation/gazebo_octomap.html">
            
                <a href="../simulation/gazebo_octomap.html">
            
                    
                    OctoMap Models with ROS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.5" data-path="raspberrypi_installation.html">
            
                <a href="raspberrypi_installation.html">
            
                    
                    ROS Installation on RPi
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.8.2.6" data-path="external_position_estimation.html">
            
                <a href="external_position_estimation.html">
            
                    
                    External Position Estimation (Vision/Motion based)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../robotics/dronekit.html">
            
                <a href="../robotics/dronekit.html">
            
                    
                    DroneKit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../debug/">
            
                <a href="../debug/">
            
                    
                    Debugging/Logging
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../debug/faq.html">
            
                <a href="../debug/faq.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../debug/system_console.html">
            
                <a href="../debug/system_console.html">
            
                    
                    System Console
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../debug/gdb_debugging.html">
            
                <a href="../debug/gdb_debugging.html">
            
                    
                    Autopilot Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../debug/sensor_uorb_topic_debugging.html">
            
                <a href="../debug/sensor_uorb_topic_debugging.html">
            
                    
                    Sensor/Topic Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="../debug/simulation_debugging.html">
            
                <a href="../debug/simulation_debugging.html">
            
                    
                    Simulation Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="../debug/debug_values.html">
            
                <a href="../debug/debug_values.html">
            
                    
                    Sending Debug Values
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="../debug/system_wide_replay.html">
            
                <a href="../debug/system_wide_replay.html">
            
                    
                    System-wide Replay
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="../debug/profiling.html">
            
                <a href="../debug/profiling.html">
            
                    
                    Profiling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="../log/logging.html">
            
                <a href="../log/logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.10" data-path="../log/flight_log_analysis.html">
            
                <a href="../log/flight_log_analysis.html">
            
                    
                    Flight Log Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.11" data-path="../log/ulog_file_format.html">
            
                <a href="../log/ulog_file_format.html">
            
                    
                    ULog File Format
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../tutorials/tutorials.html">
            
                <a href="../tutorials/tutorials.html">
            
                    
                    Tutorials
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../qgc/">
            
                <a href="../qgc/">
            
                    
                    Ground Control Station
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../qgc/video_streaming.html">
            
                <a href="../qgc/video_streaming.html">
            
                    
                    Video Streaming in QGC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="../qgc/video_streaming_wifi_broadcast.html">
            
                <a href="../qgc/video_streaming_wifi_broadcast.html">
            
                    
                    Long-distance Video Streaming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="../tutorials/linux_sbus.html">
            
                <a href="../tutorials/linux_sbus.html">
            
                    
                    S.Bus Driver for Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../advanced/">
            
                <a href="../advanced/">
            
                    
                    Advanced Topics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../advanced/parameters_and_configurations.html">
            
                <a href="../advanced/parameters_and_configurations.html">
            
                    
                    Parameters & Configs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../advanced/parameter_reference.html">
            
                <a href="../advanced/parameter_reference.html">
            
                    
                    Parameter Reference
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../advanced/computer_vision.html">
            
                <a href="../advanced/computer_vision.html">
            
                    
                    Computer Vision
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.3.1" data-path="../tutorials/motion-capture-vicon-optitrack.html">
            
                <a href="../tutorials/motion-capture-vicon-optitrack.html">
            
                    
                    Motion Capture (VICON, Optitrack)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="../advanced/realsense_intel_driver.html">
            
                <a href="../advanced/realsense_intel_driver.html">
            
                    
                    Installing driver for Intel RealSense R200
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.5" data-path="../advanced/switching_state_estimators.html">
            
                <a href="../advanced/switching_state_estimators.html">
            
                    
                    Switching State Estimators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6" data-path="../advanced/out_of_tree_modules.html">
            
                <a href="../advanced/out_of_tree_modules.html">
            
                    
                    Out-of-Tree Modules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.7" data-path="../software_update/stm32_bootloader.html">
            
                <a href="../software_update/stm32_bootloader.html">
            
                    
                    STM32 Bootloader
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../test_and_ci/">
            
                <a href="../test_and_ci/">
            
                    
                    Platform Testing and CI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../test_and_ci/test_flights.html">
            
                <a href="../test_and_ci/test_flights.html">
            
                    
                    Test Flights
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1.1" data-path="../test_cards/mc_01_manual_modes.html">
            
                <a href="../test_cards/mc_01_manual_modes.html">
            
                    
                    Test MC_01 - Manual Modes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.1.2" data-path="../test_cards/mc_02_full_autonomous.html">
            
                <a href="../test_cards/mc_02_full_autonomous.html">
            
                    
                    Test MC_02 - Full Autonomous
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.1.3" data-path="../test_cards/mc_03_auto_manual_mix.html">
            
                <a href="../test_cards/mc_03_auto_manual_mix.html">
            
                    
                    Test MC_03 - Auto Manual Mix
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.1.4" data-path="../test_cards/mc_04_failsafe_testing.html">
            
                <a href="../test_cards/mc_04_failsafe_testing.html">
            
                    
                    Test MC_04 - Failsafe Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.1.5" data-path="../test_cards/mc_05_indoor_flight_manual_modes.html">
            
                <a href="../test_cards/mc_05_indoor_flight_manual_modes.html">
            
                    
                    Test MC_05 - Indoor Flight (Manual Modes)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../test_and_ci/unit_tests.html">
            
                <a href="../test_and_ci/unit_tests.html">
            
                    
                    Unit Tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../test_and_ci/continous_integration.html">
            
                <a href="../test_and_ci/continous_integration.html">
            
                    
                    Continuous Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="../test_and_ci/jenkins_ci.html">
            
                <a href="../test_and_ci/jenkins_ci.html">
            
                    
                    Jenkins Continuous Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="../test_and_ci/integration_testing.html">
            
                <a href="../test_and_ci/integration_testing.html">
            
                    
                    Integration Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="../test_and_ci/docker.html">
            
                <a href="../test_and_ci/docker.html">
            
                    
                    Docker Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="../test_and_ci/maintenance.html">
            
                <a href="../test_and_ci/maintenance.html">
            
                    
                    Maintenance
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../contribute/">
            
                <a href="../contribute/">
            
                    
                    Contribution (&Dev Call)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../contribute/dev_call.html">
            
                <a href="../contribute/dev_call.html">
            
                    
                    Dev Call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../contribute/code.html">
            
                <a href="../contribute/code.html">
            
                    
                    Source Code Management
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.2.1" data-path="../contribute/git_examples.html">
            
                <a href="../contribute/git_examples.html">
            
                    
                    GIT Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="../contribute/docs.html">
            
                <a href="../contribute/docs.html">
            
                    
                    Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.4" data-path="../contribute/translation.html">
            
                <a href="../contribute/translation.html">
            
                    
                    Translation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.5" data-path="../contribute/notation.html">
            
                <a href="../contribute/notation.html">
            
                    
                    Terminology/Notation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.6" data-path="../contribute/licenses.html">
            
                <a href="../contribute/licenses.html">
            
                    
                    Licenses
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../contribute/support.html">
            
                <a href="../contribute/support.html">
            
                    
                    Support
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Dronecode Shortcuts</li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <a target="_blank" href="https://docs.px4.io/en/">
            
                    
                    PX4 User Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" >
            
                <a target="_blank" href="https://docs.qgroundcontrol.com/en/">
            
                    
                    QGroundControl User Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" >
            
                <a target="_blank" href="https://dev.qgroundcontrol.com/en/">
            
                    
                    QGroundControl Developer Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" >
            
                <a target="_blank" href="https://mavlink.io/en/">
            
                    
                    MAVLink Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" >
            
                <a target="_blank" href="https://sdk.dronecode.org/en/">
            
                    
                    Dronecode SDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" >
            
                <a target="_blank" href="https://camera-manager.dronecode.org/en/">
            
                    
                    Dronecode Camera Manager
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >External Position Estimation (Vision/Motion based)</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="using-vision-or-motion-capture-systems-for-position-estimation"><a name="using-vision-or-motion-capture-systems-for-position-estimation" class="plugin-anchor" href="#using-vision-or-motion-capture-systems-for-position-estimation"><i class="fa fa-link" aria-hidden="true"></i></a>Using Vision or Motion Capture Systems for Position Estimation</h1>
<p>Visual Inertial Odometry (VIO) and and Motion Capture (MoCap) systems allow vehicles to navigate when a global position source is unavailable or unreliable (e.g. indoors, or when flying under a bridge. etc.).</p>
<p>Both VIO and MoCap determine a vehicle&apos;s <em>pose</em> (position and attitude) from &quot;visual&quot; information.
The main difference between them is the frame perspective: </p>
<ul>
<li>VIO uses <em>onboard sensors</em> to get pose data from the vehicle&apos;s perspective (see <a href="https://en.wikipedia.org/wiki/Visual_odometry#Egomotion" target="_blank">egomotion</a>).</li>
<li>MoCap uses a system of <em>off-board cameras</em> to get vehicle pose data in a 3D space (i.e. it is an external system that tells the vehicle its pose).</li>
</ul>
<p>Pose data from either type of system can be used to update a PX4-based autopilot&apos;s local position estimate (relative to the local origin) and also can optionally also be fused into the vehicle attitude estimation.</p>
<p>This topic explains how to configure a PX4-based system to get data from MoCap/VIO systems (either via ROS or some other MAVLink system) and more specifically how to set up MoCap systems like VICON and Optitrack, and vision-based estimation systems like <a href="https://github.com/ethz-asl/rovio" target="_blank">ROVIO</a>, <a href="https://github.com/uzh-rpg/rpg_svo" target="_blank">SVO</a> and <a href="https://github.com/ethz-asl/ethzasl_ptam" target="_blank">PTAM</a>).</p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-2x fa-edit"></strong>
<p> The instructions differ depending on whether you are using the EKF2 or LPE estimator.</p>
</blockquote>
<h2 id="px4-mavlink-integration"><a name="px4-mavlink-integration" class="plugin-anchor" href="#px4-mavlink-integration"><i class="fa fa-link" aria-hidden="true"></i></a>PX4 MAVLink Integration</h2>
<p>PX4 uses the following MAVLink messages for getting external position information, and maps them to <a href="http://dev.px4.io/en/middleware/uorb.html" target="_blank">uORB topics</a>:</p>
<table>
<thead>
<tr>
<th>MAVLink</th>
<th>uORB </th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank">VISION_POSITION_ESTIMATE</a></td>
<td><code>vehicle_visual_odometry</code></td>
</tr>
<tr>
<td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_VISION_NED" target="_blank">MAV_FRAME_VISION_NED</a>)</td>
<td><code>vehicle_visual_odometry</code></td>
</tr>
<tr>
<td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank">ATT_POS_MOCAP</a></td>
<td><code>vehicle_mocap_odometry</code></td>
</tr>
<tr>
<td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_MOCAP_NED" target="_blank">MAV_FRAME_MOCAP_NED</a>)</td>
<td><code>vehicle_mocap_odometry</code></td>
</tr>
</tbody>
</table>
<p>EKF2 only subscribes to <code>vehicle_visual_odometry</code> topics and can hence only process the first two messages
(a MoCap system must generate these messages to work with EKF2).
The LPE estimator subscribes to both topics, and can hence process all the above messages.</p>
<blockquote class="clearfix alert alert-success"><strong class="fa fa-2x fa-thumbs-o-up"></strong>
<p> EFK2 is the default estimator used by PX4.
  It is better tested and supported than LPE, and should be used by preference.</p>
</blockquote>
<p>The messages should be streamed at between 30Hz (if containing covariances) and 50 Hz.</p>
<p>The following MAVLink &quot;vision&quot; messages are not currently supported by PX4: 
<a href="https://mavlink.io/en/messages/common.html#GLOBAL_VISION_POSITION_ESTIMATE" target="_blank">GLOBAL_VISION_POSITION_ESTIMATE</a>, 
<a href="https://mavlink.io/en/messages/common.html#VISION_SPEED_ESTIMATE" target="_blank">VISION_SPEED_ESTIMATE</a>, 
<a href="https://mavlink.io/en/messages/common.html#VICON_POSITION_ESTIMATE" target="_blank">VICON_POSITION_ESTIMATE</a></p>
<h2 id="reference-frames"><a name="reference-frames" class="plugin-anchor" href="#reference-frames"><i class="fa fa-link" aria-hidden="true"></i></a>Reference Frames</h2>
<p>PX4 uses FRD (X <strong>F</strong>orward, Y <strong>R</strong>ight and Z <strong>D</strong>own) for the local body frame, and NED (X <strong>N</strong>orth, Y <strong>E</strong>ast, Z <strong>D</strong>own) for the local world frame - set in MAVLink using <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_BODY_OFFSET_NED" target="_blank">MAV_FRAME_BODY_OFFSET_NED</a> and <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_NED" target="_blank">MAV_FRAME_LOCAL_NED</a>, respectively.</p>
<p>Depending on your source your source system reference frame you will need to apply a custom transformation to obtain the appropriate NED convention when sending the MAVLink Vision/MoCap messages.</p>
<blockquote class="clearfix alert alert-success"><strong class="fa fa-2x fa-thumbs-o-up"></strong>
<p> ROS users can find more detailed instructions below in <a href="#ros_reference_frames">Reference Frames and ROS</a>.</p>
</blockquote>
<p>For example, if using the Optitrack framework the local frame has <script type="math/tex; ">x</script> and <script type="math/tex; ">z</script> on the horizontal plane (<em>x</em> front and <em>z</em> right) while <em>y</em> axis is vertical and pointing up. 
A simple trick is swapping axis in order to obtained NED convention. </p>
<p>If <code>x_{mav}</code>, <code>y_{mav}</code> and <code>z_{mav}</code> are the coordinates that are sent through MAVLink as position feedback, then we obtain:</p>
<pre><code>x_{mav} = x_{mocap}
y_{mav} = z_{mocap}
z_{mav} = - y_{mocap}
</code></pre><p>Regarding the orientation, keep the scalar part <em>w</em> of the quaternion the same and swap the vector part <em>x</em>, <em>y</em> and <em>z</em> in the same way. 
You can apply this trick with every system - if you need to obtain a NED frame, look at your MoCap output and swap axis accordingly.</p>
<h2 id="ekf2-tuningconfiguration"><a name="ekf2-tuningconfiguration" class="plugin-anchor" href="#ekf2-tuningconfiguration"><i class="fa fa-link" aria-hidden="true"></i></a>EKF2 Tuning/Configuration</h2>
<p>The following parameters must be set to use external position information with EKF2 (these can be set in <em>QGroundControl</em> &gt; <strong>Vehicle Setup &gt; Parameters &gt; EKF2</strong>).</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Setting for External Position Estimation</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../advanced/parameter_reference.html#EKF2_AID_MASK">EKF2_AID_MASK</a></td>
<td>Set <em>vision position fusion</em> and <em>vision yaw fusion</em></td>
</tr>
<tr>
<td><a href="../advanced/parameter_reference.html#EKF2_HGT_MODE">EKF2_HGT_MODE</a></td>
<td>Set to <em>Vision</em> to use the vision a primary source for altitude estimation.</td>
</tr>
<tr>
<td><a href="../advanced/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a></td>
<td>Set to the difference between the timestamp of the measurement and the &quot;actual&quot; capture time. For more information see <a href="#tuning-EKF2_EV_DELAY">below</a>.</td>
</tr>
<tr>
<td><a href="../advanced/parameter_reference.html#EKF2_EV_POS_X">EKF2_EV_POS_X</a>, <a href="../advanced/parameter_reference.html#EKF2_EV_POS_Y">EKF2_EV_POS_Y</a>, <a href="../advanced/parameter_reference.html#EKF2_EV_POS_Z">EKF2_EV_POS_Z</a></td>
<td>Set the position of the vision sensor (or MoCap markers) with respect to the robot&apos;s body frame.</td>
</tr>
</tbody>
</table>
<blockquote class="clearfix alert alert-success"><strong class="fa fa-2x fa-thumbs-o-up"></strong>
<p> Reboot the flight controller in order for parameter changes to take effect.</p>
</blockquote>
<h4 id="tuning-EKF2_EV_DELAY"><a name="tuning-EKF2_EV_DELAY" class="plugin-anchor" href="#tuning-EKF2_EV_DELAY"><i class="fa fa-link" aria-hidden="true"></i></a>Tuning EKF2_EV_DELAY </h4>
<p><a href="../advanced/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a> is the <em>Vision Position Estimator delay relative to IMU measurements</em>.</p>
<p>Or in other words, it is the difference between the vision system timestamp and the &quot;actual&quot; capture time that would have been recorded by the IMU clock (the &quot;base clock&quot; for EKF2).</p>
<p>Technically this can be set to 0 if there is correct timestamping (not just arrival time) and timesync (e.g NTP) between MoCap and (for example) ROS computers. 
In reality, this needs some empirical tuning since delays in the entire MoCap-&gt;PX4 chain are very setup-specific. 
It is rare that a system is setup with an entirely synchronised chain!</p>
<p>A rough estimate of the delay can be obtained from logs by checking the offset between IMU rates and the EV rates:</p>
<p><img src="../../assets/ekf2/ekf2_ev_delay_tuning.png" alt="ekf2_ev_delay log"></p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-2x fa-edit"></strong>
<p> A plot of external data vs. onboard estimate (as above) can be generated using <a href="https://docs.px4.io/master/en/log/flight_log_analysis.html#flightplot" target="_blank">FlightPlot</a> or similar flight analysis tools.</p>
</blockquote>
<p>The value can further be tuned by varying the parameter to find the value that yields the lowest EKF innovations during dynamic maneuvers.</p>
<h2 id="lpe-tuningconfiguration"><a name="lpe-tuningconfiguration" class="plugin-anchor" href="#lpe-tuningconfiguration"><i class="fa fa-link" aria-hidden="true"></i></a>LPE Tuning/Configuration</h2>
<p>You will first need to <a href="../advanced/switching_state_estimators.html">switch to the LPE estimator</a> by setting the <a href="../advanced/parameter_reference.html#SYS_MC_EST_GROUP">SYS_MC_EST_GROUP</a> parameter.</p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-2x fa-edit"></strong>
<p> If targeting <code>px4_fmu-v2</code> hardware you will also need to use a firmware version that includes the LPE module (firmware for other FMU-series hardware includes both LPE and and EKF).
  The LPE version can be found in the zip file for each PX4 release or it can be built from source using the build command <code>make px4_fmu-v2_lpe</code>.
  See <a href="../setup/building_px4.html">Building the Code</a> for more details.</p>
</blockquote>
<h3 id="enabling-external-pose-input"><a name="enabling-external-pose-input" class="plugin-anchor" href="#enabling-external-pose-input"><i class="fa fa-link" aria-hidden="true"></i></a>Enabling External Pose Input</h3>
<p>The following parameters must be set to use external position information with LPE (these can be set in <em>QGroundControl</em> &gt; <strong>Vehicle Setup &gt; Parameters &gt; Local Position Estimator</strong>).</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Setting for External Position Estimation</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../advanced/parameter_reference.html#LPE_FUSION">LPE_FUSION</a></td>
<td>Vision integration is enabled if <em>fuse vision position</em> is checked (it is enabled by default).</td>
</tr>
<tr>
<td><a href="../advanced/parameter_reference.html#ATT_EXT_HDG_M">ATT_EXT_HDG_M</a></td>
<td>Set to 1 or 2 to enable external heading integration. Setting it to 1 will cause vision to be used, while 2 enables MoCap heading use. </td>
</tr>
</tbody>
</table>
<h3 id="disabling-barometer-fusion"><a name="disabling-barometer-fusion" class="plugin-anchor" href="#disabling-barometer-fusion"><i class="fa fa-link" aria-hidden="true"></i></a>Disabling Barometer Fusion</h3>
<p>If a highly accurate altitude is already available from VIO or MoCap information, it may be useful to disable the baro correction in LPE to reduce drift on the Z axis.</p>
<p>This can be done by in <em>QGroundControl</em> by unchecking the <em>fuse baro</em> option in the <a href="../advanced/parameter_reference.html#LPE_FUSION">LPE_FUSION</a> parameter.</p>
<h3 id="tuning-noise-parameters"><a name="tuning-noise-parameters" class="plugin-anchor" href="#tuning-noise-parameters"><i class="fa fa-link" aria-hidden="true"></i></a>Tuning Noise Parameters</h3>
<p>If your vision or MoCap data is highly accurate, and you just want the estimator to track it tightly, you should reduce the standard deviation parameters: <a href="../advanced/parameter_reference.html#LPE_VIS_XY">LPE_VIS_XY</a> and <a href="../advanced/parameter_reference.html#LPE_VIS_Z">LPE_VIS_Z</a> (for VIO) or <a href="../advanced/parameter_reference.html#LPE_VIC_P">LPE_VIC_P</a> (for MoCap). 
Reducing them will cause the estimator to trust the incoming pose estimate more. 
You may need to set them lower than the allowed minimum and force-save. </p>
<blockquote class="clearfix alert alert-success"><strong class="fa fa-2x fa-thumbs-o-up"></strong>
<p> If performance is still poor, try increasing the <a href="../advanced/parameter_reference.html#LPE_PN_V">LPE_PN_V</a> parameter. 
  This will cause the estimator to trust measurements more during velocity estimation.</p>
</blockquote>
<h2 id="working-with-ros"><a name="working-with-ros" class="plugin-anchor" href="#working-with-ros"><i class="fa fa-link" aria-hidden="true"></i></a>Working with ROS</h2>
<p>ROS is not <em>required</em> for supplying external pose information, but is highly recommended as it already comes with good integrations with VIO and MoCap systems.
PX4 must already have been set up as above.</p>
<h3 id="getting-pose-data-into-ros"><a name="getting-pose-data-into-ros" class="plugin-anchor" href="#getting-pose-data-into-ros"><i class="fa fa-link" aria-hidden="true"></i></a>Getting Pose Data Into ROS</h3>
<p>VIO and MoCap systems have different ways of obtaining pose data, and have their own setup and topics.</p>
<p>The setup for specific systems is covered <a href="#setup_specific_systems">below</a>. 
For other systems consult the vendor setup documentation.</p>
<h3 id="relaying_pose_data_to_px4"><a name="relaying_pose_data_to_px4" class="plugin-anchor" href="#relaying_pose_data_to_px4"><i class="fa fa-link" aria-hidden="true"></i></a>Relaying Pose Data to PX4 </h3>
<p>MAVROS has plugins to relay a visual estimation from a VIO or MoCap system using the following pipelines:</p>
<table>
<thead>
<tr>
<th>ROS</th>
<th>MAVLink</th>
<th>uORB </th>
</tr>
</thead>
<tbody>
<tr>
<td>/mavros/vision_pose/pose</td>
<td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank">VISION_POSITION_ESTIMATE</a></td>
<td><code>vehicle_visual_odometry</code></td>
</tr>
<tr>
<td>/mavros/odometry/odom</td>
<td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_VISION_NED" target="_blank">MAV_FRAME_VISION_NED</a>)</td>
<td><code>vehicle_visual_odometry</code></td>
</tr>
<tr>
<td>/mavros/mocap/pose</td>
<td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank">ATT_POS_MOCAP</a></td>
<td><code>vehicle_mocap_odometry</code></td>
</tr>
<tr>
<td>/mavros/odometry/odom</td>
<td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_MOCAP_NED" target="_blank">MAV_FRAME_MOCAP_NED</a>)</td>
<td><code>vehicle_mocap_odometry</code></td>
</tr>
</tbody>
</table>
<p>You can use any of the above pipelines with LPE. </p>
<p>If you&apos;re working with EKF2, only the &quot;vision&quot; pipelines are supported. 
To use MoCap data with EKF2 you will have to <a href="http://wiki.ros.org/roslaunch/XML/remap" target="_blank">remap</a> the pose topic that you get from MoCap:</p>
<ul>
<li>MoCap ROS topics of type <code>geometry_msgs/PoseStamped</code> or <code>geometry_msgs/PoseWithCovarianceStamped</code> must be remapped to <code>/mavros/vision_pose/pose</code>. 
The <code>geometry_msgs/PoseStamped</code> topic is most common as MoCap doesn&apos;t usually have associated covariances to the data.</li>
<li>If you get data through a <code>nav_msgs/Odometry</code> ROS message then you will need to remap it to <code>/mavros/odometry/odom</code>.</li>
</ul>
<h3 id="ros_reference_frames"><a name="ros_reference_frames" class="plugin-anchor" href="#ros_reference_frames"><i class="fa fa-link" aria-hidden="true"></i></a>Reference Frames and ROS </h3>
<p>The local/world and world frames used by ROS and PX4 are different.</p>
<table>
<thead>
<tr>
<th>Frame</th>
<th>ROS</th>
<th>PX4</th>
</tr>
</thead>
<tbody>
<tr>
<td>Body</td>
<td>FLU (X <strong>F</strong>orward, Y <strong>L</strong>eft, Z <strong>U</strong>p), usually named <code>base_link</code></td>
<td>FRD (X <strong>F</strong>orward, Y <strong>R</strong>ight and Z <strong>D</strong>own)</td>
</tr>
<tr>
<td>World</td>
<td>ENU (X <strong>E</strong>ast, Y <strong>N</strong>orth and Z Up), with the naming being <code>odom</code> or <code>map</code></td>
<td>NED (X <strong>N</strong>orth, Y <strong>E</strong>ast, Z <strong>D</strong>own)</td>
</tr>
</tbody>
</table>
<blockquote class="clearfix alert alert-success"><strong class="fa fa-2x fa-thumbs-o-up"></strong>
<p> See <a href="http://www.ros.org/reps/rep-0105.html" target="_blank">REP105: Coordinate Frames for Mobile Platforms</a> for more information about ROS frames.</p>
</blockquote>
<p>Both frames are shown in the image below (NED on left/ENU on right).</p>
<p><img src="../../assets/lpe/ref_frames.png" alt="Reference frames"></p>
<p>When using external heading estimation, magnetic North is ignored and faked with a vector corresponding to world <em>x</em> axis (which can be placed freely during Vision/MoCap calibration). Yaw angle is therefore given with respect to local <em>x</em>.</p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-2x fa-edit"></strong>
<p> When creating the rigid body in the MoCap software, remember to first align the robot&apos;s local <em>x</em> axis with the world <em>x</em> axis otherwise yaw estimation will have an initial offset.</p>
</blockquote>
<p>Using MAVROS, this operation is straightforward. 
ROS uses ENU frames as convention, therefore position feedback must be provided in ENU. 
If you have an Optitrack system you can use <a href="https://github.com/ros-drivers/mocap_optitrack" target="_blank">mocap_optitrack</a> node which streams the object pose on a ROS topic already in ENU. 
With a remapping you can directly publish it on <code>mocap_pose_estimate</code> as it is without any transformation and MAVROS will take care of NED conversions.</p>
<h2 id="setup_specific_systems"><a name="setup_specific_systems" class="plugin-anchor" href="#setup_specific_systems"><i class="fa fa-link" aria-hidden="true"></i></a>Specific System Setups </h2>
<h3 id="optitrack-mocap"><a name="optitrack-mocap" class="plugin-anchor" href="#optitrack-mocap"><i class="fa fa-link" aria-hidden="true"></i></a>OptiTrack MoCap</h3>
<p>The following steps explain how to feed position estimates from an <a href="https://optitrack.com/motion-capture-robotics/" target="_blank">OptiTrack</a> system to PX4. 
It is assumed that the MoCap system is calibrated. 
See <a href="https://www.youtube.com/watch?v=cNZaFEghTBU" target="_blank">this video</a> for a tutorial on the calibration process.</p>
<h4 id="steps-on-the-motive-mocap-software"><a name="steps-on-the-motive-mocap-software" class="plugin-anchor" href="#steps-on-the-motive-mocap-software"><i class="fa fa-link" aria-hidden="true"></i></a>Steps on the <em>Motive</em> MoCap software</h4>
<ul>
<li>Align your robot&apos;s forward direction with the the <a href="https://v20.wiki.optitrack.com/index.php?title=Template:Coordinate_System" target="_blank">system +x-axis</a></li>
<li><a href="https://www.youtube.com/watch?v=1e6Qqxqe-k0" target="_blank">Define a rigid body in the Motive software</a>. Give the robot a name that does not contain spaces, e.g. <code>robot1</code> instead of <code>Rigidbody 1</code></li>
<li><a href="https://www.youtube.com/watch?v=yYRNG58zPFo" target="_blank">Enable Frame Broadacst and VRPN streaming</a></li>
<li>Set the Up axis to be the Z axis (the default is Y)</li>
</ul>
<h4 id="getting-pose-data-into-ros"><a name="getting-pose-data-into-ros" class="plugin-anchor" href="#getting-pose-data-into-ros"><i class="fa fa-link" aria-hidden="true"></i></a>Getting pose data into ROS</h4>
<ul>
<li>Install the <code>vrpn_client_ros</code> package</li>
<li>You can get each rigid body pose on an individual topic by running<pre><code class="lang-bash">roslaunch vrpn_client_ros sample.launch server:=&lt;mocap machine ip&gt;
</code></pre>
</li>
</ul>
<p>If you named the rigidbody as <code>robot1</code>, you will get a topic like <code>/vrpn_client_node/robot1/pose</code></p>
<h4 id="relayingremapping-pose-data"><a name="relayingremapping-pose-data" class="plugin-anchor" href="#relayingremapping-pose-data"><i class="fa fa-link" aria-hidden="true"></i></a>Relaying/remapping Pose Data</h4>
<p>MAVROS provides a plugin to relay pose data published on <code>/mavros/vision_pose/pose</code> to PX4. 
Assuming that MAVROS is running, you just need to <strong>remap</strong> the pose topic that you get from MoCap <code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> directly to <code>/mavros/vision_pose/pose</code>. 
Note that there is also a <code>mocap</code> topic that MAVROS provides to feed <code>ATT_POS_MOCAP</code> to PX4, but it is not applicable for EKF2. 
However, it is applicable with LPE.</p>
<blockquote class="clearfix alert alert-info"><strong class="fa fa-2x fa-edit"></strong>
<p> Remapping pose topics is covered above <a href="#relaying_pose_data_to_px4">Relaying pose data to PX4</a>
  (<code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> is of type <code>geometry_msgs/PoseStamped</code>).</p>
</blockquote>
<p>Assuming that you have configured EKF2 parameters as described above, PX4 now is set and fusing MoCap data.</p>
<p>You are now set to proceed to the first flight.</p>
<h2 id="first-flight"><a name="first-flight" class="plugin-anchor" href="#first-flight"><i class="fa fa-link" aria-hidden="true"></i></a>First Flight</h2>
<p>After setting up one of the (specific) systems described above you should now be ready to test.
The instructions below show how to do so for MoCap and VIO systems </p>
<h3 id="mocap-first-flight"><a name="mocap-first-flight" class="plugin-anchor" href="#mocap-first-flight"><i class="fa fa-link" aria-hidden="true"></i></a>MoCap First Flight</h3>
<p>Be sure to perform the following checks:</p>
<ul>
<li><strong>Before</strong> creating the rigid body, align the robot with world x axis.</li>
<li>Stream over MAVLink and check the MAVLink inspector with <em>QGroundControl</em>, the local pose topic should be in NED.</li>
<li>Move the robot around by hand and see if the estimated local position is consistent (always in NED).</li>
<li>Rotate the robot on the vertical axis and check the yaw with the MAVLink inspector.</li>
</ul>
<p>If those steps are consistent, you can try your first flight.</p>
<p>Put the robot on the ground and start streaming MoCap feedback. 
Lower your left (throttle) stick and arm the motors.</p>
<p>At this point, with the left stick at the lowest position, switch to position control. 
You should have a green light. 
The green light tells you that position feedback is available and position control is now activated. </p>
<p>Put your left stick at the middle, this is the dead zone. 
With this stick value, the robot maintains its altitude; 
raising the stick will increase the reference altitude while lowering the value will decrease it. 
Same for right stick on x and y. </p>
<p>Increase the value of the left stick and the robot will take off, 
put it back to the middle right after. Check if it is able to keep its position.</p>
<p>If it works, you may want to set up an <a href="offboard_control.html">offboard</a> experiment by sending position-setpoint from a remote ground station.</p>
<h3 id="vio-first-flight"><a name="vio-first-flight" class="plugin-anchor" href="#vio-first-flight"><i class="fa fa-link" aria-hidden="true"></i></a>VIO First Flight</h3>
<p>TBD.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="raspberrypi_installation.html" class="navigation navigation-prev " aria-label="Previous page: ROS Installation on RPi">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../robotics/dronekit.html" class="navigation navigation-next " aria-label="Next page: DroneKit">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"External Position Estimation (Vision/Motion based)","level":"1.8.2.6","depth":3,"next":{"title":"DroneKit","level":"1.8.3","depth":2,"path":"robotics/dronekit.md","ref":"robotics/dronekit.md","articles":[]},"previous":{"title":"ROS Installation on RPi","level":"1.8.2.5","depth":3,"path":"ros/raspberrypi_installation.md","ref":"ros/raspberrypi_installation.md","articles":[]},"dir":"ltr"},"config":{"plugins":["youtube","richquotes@git+https://github.com/Dronecode/gitbook-plugin-richquotes.git","collapsible-menu","anchors","page-toc-button","ga","language-picker","custom-favicon","bulk-redirect@git+https://github.com/Dronecode/gitbook-plugin-bulk-redirect.git","toolbar@git+https://github.com/hamishwillee/gitbook-plugin-toolbar.git","validate-links","versions-select@git+https://github.com/Dronecode/gitbook-plugin-versions-select.git","mathjax@git+https://github.com/Dronecode/plugin-mathjax.git#update_cdn","mermaid","-stub-out-blocks@git+https://github.com/hamishwillee/gitbook-plugin-stub-out-blocks.git","theme-dronecode@git+https://github.com/dronecode/theme-dronecode.git"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"theme-dronecode":{"logo":{"logo_large":"gitbook-plugin-theme-dronecode/images/dronecode_top_bar_logo_full.png","logo_small":"gitbook-plugin-theme-dronecode/images/dronecode_top_bar_logo_small.png","url":"https://www.dronecode.org/"}},"validate-links":{"defaultScheme":"https","local":"warn","remote":"disabled"},"collapsible-menu":{},"language-picker":{"grid-columns":3},"youtube":{},"search":{},"mermaid":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"versions-select":{"type":"branches"},"fontsettings":{"theme":"white","family":"sans","size":2},"richquotes":{"tip":{"alert":"success","picto":"fa-thumbs-o-up"}},"highlight":{},"favicon":"favicon.ico","page-toc-button":{},"bulk-redirect":{"basepath":"/","redirectsFile":"redirects.json"},"custom-favicon":{},"mathjax":{"forceSVG":false,"version":"2.7.1"},"ga":{"configuration":"auto","token":"UA-33658859-3"},"versions":{"gitbookConfigURL":"https://raw.githubusercontent.com/PX4/Devguide/master/book.json","options":[{"value":"https://dev.px4.io/en/","text":"stable (v1.8.2)"},{"value":"https://dev.px4.io/master/en/","text":"master"},{"value":"https://dev.px4.io/v1.8.2/en/","text":"1.8.2"},{"value":"https://dev.px4.io/v1.8.0/en/","text":"1.8.0"}]},"toolbar":{"buttons":[{"label":"Bug tracker","icon":"fa fa-bug","position":"left","url":"https://github.com/PX4/Devguide/issues/new?title=Doc+Bug:+{{title}}&body=DESCRIBE+PROBLEM+WITH+DOCS+HERE%0A%0ABug+Page:+[{{title}}]({{url}})"},{"label":"GitHub","icon":"fa fa-github","url":"https://github.com/PX4/Devguide"},{"label":"Edit page on github","icon":"fa fa-pencil-square-o","position":"left","url":"https://github.com/PX4/Devguide/edit/master/{{filepath_lang}}"}]},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"logo":"./assets/site/logo_pro_small.png","px4_version":"v1.9.0"},"title":"PX4 v1.9.0 Developer Guide","language":"en","gitbook":"*"},"file":{"path":"ros/external_position_estimation.md","mtime":"2019-05-28T02:20:35.226Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-28T02:22:17.119Z"},"basePath":"..","book":{"language":"en"}});
        });
    </script>
</div>

    

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-language-picker/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-toolbar/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-versions-select/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

